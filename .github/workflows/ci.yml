name: CI Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  JAVA_VERSION: '21'
  MAVEN_OPTS: '-Xmx2048m'

jobs:
  # ============================================
  # STEP 1: Google Java Format Validation
  # ============================================
  format-check:
    name: Google Java Format Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Check Google Java Format
        run: mvn spotless:check -B

      - name: Format check failed - show diff
        if: failure()
        run: |
          echo "Code formatting issues detected!"
          echo "Run 'mvn spotless:apply' locally to fix formatting."
          mvn spotless:apply -B
          git diff --color=always

  # ============================================
  # STEP 2: SonarCloud Quality Scan
  # ============================================
  sonar-scan:
    name: SonarCloud Quality Scan
    runs-on: ubuntu-latest
    needs: format-check

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Build and Test with Coverage
        run: mvn clean verify -Pcoverage -B

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: |
            **/target/site/jacoco/
          retention-days: 7

      - name: Generate Coverage Summary
        if: always()
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for module in core api-gateway security-analysis-api llm-worker; do
            if [ -f "$module/target/site/jacoco/index.html" ]; then
              coverage=$(grep -oP 'Total[^%]*\K[0-9]+%' "$module/target/site/jacoco/index.html" | head -1 || echo "N/A")
              echo "- **$module**: $coverage" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: SonarCloud Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn sonar:sonar \
            -Dsonar.projectKey=${{ vars.SONAR_PROJECT_KEY }} \
            -Dsonar.organization=${{ vars.SONAR_ORGANIZATION }} \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.qualitygate.wait=true \
            -B

      - name: Quality Gate Status
        if: always()
        run: |
          echo "## SonarCloud Quality Gate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Quality gate enforcement is enabled. The build will fail if:" >> $GITHUB_STEP_SUMMARY
          echo "- Code coverage drops below 70%" >> $GITHUB_STEP_SUMMARY
          echo "- Reliability rating is worse than A (any bugs)" >> $GITHUB_STEP_SUMMARY
          echo "- Security rating is worse than A (any vulnerabilities)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View detailed report on SonarCloud](https://sonarcloud.io/project/overview?id=${{ vars.SONAR_PROJECT_KEY }})" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # STEP 3: SAST Security Analysis
  # ============================================
  sast-analysis:
    name: SAST Security Analysis
    runs-on: ubuntu-latest
    needs: format-check

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache NVD Database
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository/org/owasp/dependency-check-data
          key: ${{ runner.os }}-nvd-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-nvd-

      - name: Run SpotBugs with Find Security Bugs
        run: mvn compile spotbugs:check -Psecurity -B
        continue-on-error: false

      - name: Run OWASP Dependency-Check
        run: mvn dependency-check:aggregate -Psecurity -B
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}

      - name: Upload SpotBugs Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: spotbugs-reports
          path: |
            **/target/spotbugsXml.xml
            **/target/spotbugs.html
          retention-days: 7

      - name: Upload Dependency-Check Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-reports
          path: |
            **/target/dependency-check/
          retention-days: 7

      - name: SAST Summary
        if: always()
        run: |
          echo "## SAST Security Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SpotBugs + Find Security Bugs" >> $GITHUB_STEP_SUMMARY
          echo "Static analysis for security vulnerabilities in Java code." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### OWASP Dependency-Check" >> $GITHUB_STEP_SUMMARY
          echo "Scans dependencies for known CVEs (fails on CVSS >= 7.0)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "target/dependency-check/dependency-check-report.html" ]; then
            echo "Dependency-Check report generated. Download artifacts for details." >> $GITHUB_STEP_SUMMARY
          fi
