# syntax=docker/dockerfile:1

# ============================================================================
# AI Code Reviewer - API Gateway (Development)
# Development Dockerfile with debug support
# ============================================================================

ARG JAVA_VERSION=21

# ----------------------------------------------------------------------------
# Stage 1: Dependency resolution (cached layer)
# ----------------------------------------------------------------------------
FROM maven:3.9-eclipse-temurin-${JAVA_VERSION} AS deps
WORKDIR /build

COPY pom.xml .
COPY core/pom.xml core/pom.xml
COPY api-gateway/pom.xml api-gateway/pom.xml
COPY llm-worker/pom.xml llm-worker/pom.xml

RUN --mount=type=cache,target=/root/.m2 \
    mvn dependency:go-offline -pl api-gateway -am -B -q || true

# ----------------------------------------------------------------------------
# Stage 2: Build application
# ----------------------------------------------------------------------------
FROM deps AS build
COPY core/ core/
COPY api-gateway/ api-gateway/
RUN --mount=type=cache,target=/root/.m2 \
    mvn package -pl api-gateway -am -DskipTests -B -q && \
    mv api-gateway/target/*.jar api-gateway/target/app.jar

# ----------------------------------------------------------------------------
# Stage 3: Extract layered JAR
# ----------------------------------------------------------------------------
FROM build AS extract
RUN java -Djarmode=layertools -jar api-gateway/target/app.jar extract \
    --destination api-gateway/target/extracted

# ----------------------------------------------------------------------------
# Stage 4: Development runtime with debug support
# ----------------------------------------------------------------------------
FROM eclipse-temurin:${JAVA_VERSION}-jre-jammy AS final

WORKDIR /app

# Copy layers
COPY --from=extract /build/api-gateway/target/extracted/dependencies/ ./
COPY --from=extract /build/api-gateway/target/extracted/spring-boot-loader/ ./
COPY --from=extract /build/api-gateway/target/extracted/snapshot-dependencies/ ./
COPY --from=extract /build/api-gateway/target/extracted/application/ ./

# Development JVM settings with remote debugging
ENV JAVA_OPTS="-XX:+UseContainerSupport \
    -XX:MaxRAMPercentage=75.0 \
    -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005"

EXPOSE 8080 5005

ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS org.springframework.boot.loader.launch.JarLauncher"]
